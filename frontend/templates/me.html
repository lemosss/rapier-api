{% extends 'base.html' %}
{% block title %}Minha Conta | Rapier{% endblock %}

{% block content %}
<h2 class="mb-3">Minha Conta</h2>
<div id="user-info" class="mb-4"></div>
<h5>Editar dados</h5>
<form id="edit-form" class="row gx-2 gy-2">
  <div class="col-md-6"><input type="text" class="form-control" id="full_name" name="full_name" placeholder="Nome completo"></div>
  <div class="col-md-6"><input type="email" class="form-control" id="email" name="email" placeholder="Novo email"></div>
  <div class="col-12"><button class="btn btn-primary mt-2" type="submit">Salvar</button></div>
  <div id="edit-msg"></div>
</form>
{% endblock %}
{% block scripts %}
<script>
async function fetchMe() {
  let token = localStorage.getItem('access_token');
  let d = await fetch('/api/v1/auth/me', { headers: {'Authorization': 'Bearer '+token}});
  if(d.ok) {
    let data = await d.json();
    document.getElementById('user-info').innerHTML = `
      <strong>Usuário:</strong> ${data.username} <br/>
      <strong>Email:</strong> ${data.email} <br/>
      <strong>Nome:</strong> ${data.full_name || '-'}<br/>
      <span class="badge bg-info">Papel: ${data.role}${data.role==='admin'?' (admin)':''}</span>
    `;
    document.getElementById('full_name').value = data.full_name || '';
    document.getElementById('email').value = data.email || '';
    localStorage.setItem('role', data.role);
    localStorage.setItem('username', data.username);
  } else {
    window.location = '/login';
  }
}
document.getElementById('edit-form').onsubmit = async function(e){
  e.preventDefault();
  let token = localStorage.getItem('access_token');
  const data = {
    full_name: document.getElementById('full_name').value,
    email: document.getElementById('email').value
  };
  let res = await fetch('/api/v1/auth/me', {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer '+token
    },
    body: JSON.stringify(data)
  });
  let msg = document.getElementById('edit-msg');
  if(res.ok) {
    msg.innerHTML = '<span class="text-success">Alterações salvas!</span>';
    fetchMe();
  } else {
    let r = await res.json();
    msg.innerHTML = '<span class="text-danger">' + (r.detail || 'Erro') + '</span>';
  }
}
fetchMe();
</script>
{% endblock %}
